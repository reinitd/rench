<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RenchGui</title>
    <link rel="stylesheet" href="styles/global.css" />
    <link rel="stylesheet" href="styles/loadrealm.css" />
    <script src="js/preCode.js"></script>
</head>

<body>
    <div id="moving-background"></div>

    <header id="primary">
        <pre id="ascii"><code>
            ____              _   
           | __ | ___ ___ ___| |_ 
           |    \| -_|   |  _|   |
           |__|__|___|_|_|___|_|_|
       </code></pre>
        <span>
            <button data-action="set_window_size" data-value="300x300"
                data-goto="index.html?dontShowSplash=true">Back</button>
            <button data-action="exit">Exit</button>
        </span>
    </header>

    <main id="main">
        <div id="loading-container">
            <div id="loading-spinner"></div>
        </div>
    </main>

    <audio id="select-audio" src="assets/audio/tap-mellow.mp3"></audio>
    <script src="app://dynamic.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            function callDotNet(message) {
                console.log(`[Client] Sent .NET a message: ${message}`);
                window.external.sendMessage(message);
            }

            const clickAudio = document.getElementById("select-audio");
            const main = document.getElementById("main");
            const loadingContainer = document.getElementById("loading-container");

            const options = document.querySelectorAll('[data-action]');

            if (options.length > 0) {
                options.forEach(option => {
                    option.addEventListener('click', async () => {
                        await clickAudio.play();
                        callDotNet(JSON.stringify({
                            action: option.getAttribute('data-action'),
                            value: option.getAttribute('data-value')
                        }));

                        const goto = option.getAttribute('data-goto');
                        if (goto != null) {
                            window.location.replace(goto);
                        }
                    });

                    const aud = document.createElement('audio');
                    aud.setAttribute('id', `for-${option.getAttribute('data-action')}`);
                    aud.setAttribute('src', 'assets/audio/tap-toothy.mp3');
                    aud.load();

                    option.addEventListener('mouseenter', async () => {
                        if (aud.paused) {
                            aud.currentTime = 0;
                            await aud.play();
                        } else {
                            await aud.play();
                        }
                    });
                });
            } else {
                console.error("No elements with 'data-action' attribute found.");
            }

            callDotNet(JSON.stringify({
                action: 'get_realms',
                value: null
            }));

            window.external.receiveMessage(message => handleGetRealmsResponse(message));

            function handleGetRealmsResponse(msg) {
                const m = JSON.parse(msg);
                const v = JSON.parse(m.value);

                if (m.action != "get_realms_response") {
                    return;
                }

                if (!v.success) {
                    const error = document.createElement("div");
                    const p = document.createElement("p");
                    p.textContent = v.message;

                    error.appendChild(p);
                    main.appendChild(error);
                    loadingContainer.remove();
                    return;
                }

                loadingContainer.remove();
            }

        });


        // window.external.receiveMessage(message => alert(message));
    </script>
</body>

</html>